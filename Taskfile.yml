version: '3'

vars:
  PACKAGE_NAME: notebooklm_mcp
  PYTHON_CMD: uv run python
  PYTEST_CMD: uv run pytest
  CONFIG_FILE: notebooklm-config.json

env:
  UV_PYTHON: python3.10

tasks:
  default:
    desc: "ğŸ¯ Show all available tasks"
    cmds:
      - task --list

  # =============================================================================
  # ğŸš€ UV Environment Management
  # =============================================================================

  setup:
    desc: "ğŸ”§ Complete project setup with UV"
    cmds:
      - echo "ğŸš€ Setting up NotebookLM MCP with UV..."
      - uv sync --all-groups
      - echo "âœ… Project setup complete!"
      - echo "ğŸ“ Run 'task --list' to see available commands"

  install:
    desc: "ğŸ“¦ Install project dependencies with UV"
    cmds:
      - echo "ğŸ“¦ Installing with UV..."
      - uv sync

  install-dev:
    desc: "ğŸ”§ Install development dependencies"
    cmds:
      - echo "ğŸ”§ Installing development dependencies..."
      - uv sync --group dev --group test --group lint
    deps:
      - task: install

  test:
    desc: "ğŸ§ª Run working tests with UV"
    cmds:
      - echo "ğŸ§ª Running working tests..."
      - "{{.PYTEST_CMD}} tests/test_config.py tests/test_config_real.py tests/test_comprehensive_simple.py -v"
    deps:
      - task: install

  test-quick:
    desc: "âš¡ Quick single test for validation"
    cmds:
      - echo "âš¡ Running quick validation test..."
      - "{{.PYTEST_CMD}} tests/test_config_real.py::TestServerConfig::test_default_values -v"
    deps:
      - task: install

  test-coverage:
    desc: "ğŸ“Š Run coverage analysis with UV"
    cmds:
      - echo "ğŸ“Š Running coverage analysis..."
      - uv run coverage run --source=src/{{.PACKAGE_NAME}} -m pytest tests/test_config.py tests/test_config_real.py tests/test_comprehensive_simple.py --junitxml=junit.xml
      - uv run coverage report --show-missing
      - uv run coverage xml
      - uv run coverage html
      - echo "ğŸ“‹ Coverage report generated in htmlcov/"
    deps:
      - task: install

  lint:
    desc: "ğŸ” Run linting with UV"
    cmds:
      - echo "ğŸ¦€ Running Ruff linter..."
      - uv run ruff check src/ tests/ --fix
    deps:
      - task: install

  format:
    desc: "ğŸ¨ Format code with UV"
    cmds:
      - echo "âš« Formatting with Black..."
      - uv run black src/ tests/
      - echo "ğŸ“Š Sorting imports..."
      - uv run isort src/ tests/
    deps:
      - task: install

  build:
    desc: "ğŸ—ï¸ Build package with UV"
    cmds:
      - echo "ğŸ—ï¸ Building package..."
      - uv build
      - echo "âœ… Package built successfully!"
    deps:
      - task: install

  build-check:
    desc: "âœ… Validate build artifacts"
    cmds:
      - echo "âœ… Checking build artifacts..."
      - uv run twine check dist/*
    deps:
      - task: build

  server-stdio:
    desc: "ğŸš€ Start FastMCP v2 server (STDIO mode)"
    cmds:
      - echo "ğŸš€ Starting FastMCP v2 server (STDIO)..."
      - "{{.PYTHON_CMD}} -m notebooklm_mcp.cli --config {{.CONFIG_FILE}} server"
    deps:
      - task: install

  server-http:
    desc: "ğŸŒ Start FastMCP v2 server (HTTP mode)"
    cmds:
      - echo "ğŸŒ Starting FastMCP v2 server (HTTP)..."
      - "{{.PYTHON_CMD}} -m notebooklm_mcp.cli --config {{.CONFIG_FILE}} server --transport http --port 8001 --headless"
    deps:
      - task: install

  clean:
    desc: "ğŸ§¹ Clean build artifacts"
    cmds:
      - echo "ğŸ§¹ Cleaning build artifacts..."
      - rm -rf dist/ build/ *.egg-info/
      - rm -rf htmlcov/ .coverage
      - find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true

  info:
    desc: "â„¹ï¸ Show project information"
    cmds:
      - echo "ğŸ“Š NotebookLM MCP Project Information"
      - echo "======================================"
      - echo "ğŸ·ï¸ Package {{.PACKAGE_NAME}}"
      - "{{.PYTHON_CMD}} --version"
      - uv --version
      - pwd

  # =============================================================================
  # ğŸ“‹ Dependency Management with UV
  # =============================================================================

  deps-add:
    desc: "â• Add new dependency (usage: task deps-add -- package_name)"
    cmds:
      - echo "â• Adding dependency {{.CLI_ARGS}}"
      - uv add {{.CLI_ARGS}}

  deps-add-dev:
    desc: "â• Add development dependency (usage: task deps-add-dev -- package_name)"
    cmds:
      - echo "â• Adding dev dependency {{.CLI_ARGS}}"
      - uv add --group dev {{.CLI_ARGS}}

  deps-remove:
    desc: "â– Remove dependency (usage: task deps-remove -- package_name)"
    cmds:
      - echo "â– Removing dependency {{.CLI_ARGS}}"
      - uv remove {{.CLI_ARGS}}

  deps-list:
    desc: "ğŸ“‹ List all dependencies"
    cmds:
      - echo "ğŸ“‹ Project dependencies:"
      - uv tree

  deps-lock:
    desc: "ğŸ”’ Generate dependency lockfile"
    cmds:
      - echo "ğŸ”’ Generating lockfile..."
      - uv lock

  deps-update:
    desc: "ğŸ”„ Update all dependencies"
    cmds:
      - echo "ğŸ”„ Updating dependencies..."
      - uv sync --upgrade

  # =============================================================================
  # ğŸš¨ Quality Assurance
  # =============================================================================

  enforce-test:
    desc: "ğŸš¨ MANDATORY Enforce testing after function changes"
    cmds:
      - echo "ğŸš¨ MANDATORY TESTING ENFORCEMENT"
      - echo "âš ï¸ This must pass after ANY function changes!"
      - task: test-coverage
      - echo "âœ… Test enforcement completed!"