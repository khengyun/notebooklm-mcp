name: "ğŸš€ Release with UV"

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: "ğŸ“¥ Checkout repository"
      uses: actions/checkout@v4

    - name: "âš¡ Install UV"
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        enable-cache: true

    - name: "ğŸ Set up Python"
      run: uv python install 3.11

    - name: "ğŸ“‹ Install Task"
      uses: arduino/setup-task@v2
      with:
        version: 3.x

    - name: "ï¿½ Verify UV Installation"
      run: |
        echo "UV version:"
        uv --version
        echo "UV Python installations:"
        uv python list

    - name: "ï¿½ğŸ“¦ Setup project with UV"
      run: uv sync --all-groups

    - name: "ğŸ—ï¸ Build package with UV"
      run: uv build

    - name: "âœ… Check package"
      run: uv run twine check dist/*

    - name: "ğŸ“¤ Publish to TestPyPI"
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository_url: https://test.pypi.org/legacy/
        skip_existing: true

    - name: "ğŸ‰ Publish to PyPI"
      if: startsWith(github.ref, 'refs/tags/')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}

    - name: "ğŸ·ï¸ Create GitHub Release"
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
